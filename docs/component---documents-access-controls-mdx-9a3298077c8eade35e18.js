(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{kSXX:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return i})),n.d(t,"default",(function(){return b}));n("5hJT"),n("W1QL"),n("K/PF"),n("t91x"),n("75LO"),n("PJhk"),n("mXGw");var a=n("SAVP"),r=n("TjRS");n("aD51");function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}var i={};void 0!==i&&i&&i===Object(i)&&Object.isExtensible(i)&&!i.hasOwnProperty("__filemeta")&&Object.defineProperty(i,"__filemeta",{configurable:!0,value:{name:"_frontmatter",filename:"Documents/access_controls.mdx"}});var o={_frontmatter:i},l=r.a;function b(e){var t=e.components,n=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,["components"]);return Object(a.b)(l,s({},o,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("h1",{id:"access-control"},"Access Control"),Object(a.b)("p",null,Object(a.b)("img",{alt:"Venn Diagram Showing",src:"https://static.klappir.io/img/docs/access_controls_logo.svg"})),Object(a.b)("p",null,"Every complex system needs to manage users and their access to\nits features. Klappir uses a role-based system where users get\naccess to feature-flags that are given based on their roles and\ntheir company's subscriptions to our products."),Object(a.b)("h2",{id:"high-level"},"High level"),Object(a.b)("p",null,"Each user is assigned one or more ",Object(a.b)("em",{parentName:"p"},"roles"),". Each ",Object(a.b)("em",{parentName:"p"},"role")," in turn has\naccess to one or more ",Object(a.b)("em",{parentName:"p"},"feature flags"),". Companies have subscriptions\nto our ",Object(a.b)("em",{parentName:"p"},"products")," that have ",Object(a.b)("em",{parentName:"p"},"feature flags")," associated with them.\nUsers get assigned these flags when ",Object(a.b)("em",{parentName:"p"},"both")," their roles and company\n(via product subscriptions) have access to them."),Object(a.b)("p",null,Object(a.b)("img",{alt:"Venn Diagram Showing",src:"https://static.klappir.io/img/docs/access_controls_venn_diagram.svg"})),Object(a.b)("p",null,"For historic reasons, and in case of exceptional custom features,\nusers also get access to any flag that is linked to their company\nin ",Object(a.b)("inlineCode",{parentName:"p"},"company_permissions")," (and possibly soon flags in\n",Object(a.b)("inlineCode",{parentName:"p"},"user_permissions"),")"),Object(a.b)("h3",{id:"glossary"},"Glossary"),Object(a.b)("table",null,Object(a.b)("thead",{parentName:"table"},Object(a.b)("tr",{parentName:"thead"},Object(a.b)("th",s({parentName:"tr"},{align:null})),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Db Table Name(s) *"),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Description"),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Example"))),Object(a.b)("tbody",{parentName:"table"},Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("strong",{parentName:"td"},"Feature flag")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"permission_keys")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"String that gives access to features and data in the system."),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"advance_maritime_voyages_full"))),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("strong",{parentName:"td"},"Product")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"products"),", ",Object(a.b)("inlineCode",{parentName:"td"},"product_permissions")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"A set of feature flags that probably costs a monthly fee."),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"advance_maritime"))),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("strong",{parentName:"td"},"Role")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"roles"),", ",Object(a.b)("inlineCode",{parentName:"td"},"role_permissions")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"Every user belongs to one or more roles, that in turn give the user access to a set of feature flags."),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"ship_captain"))),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("strong",{parentName:"td"},"Subscription")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"company_subscriptions"),", ",Object(a.b)("inlineCode",{parentName:"td"},"asset_subscriptions")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"Subscriptions to products, with a start and (possibly) end date."),Object(a.b)("td",s({parentName:"tr"},{align:null}))))),Object(a.b)("p",null,"*All tables are under the ",Object(a.b)("inlineCode",{parentName:"p"},"klappir_core_ui")," schema"),Object(a.b)("h2",{id:"database-implementation"},"Database Implementation"),Object(a.b)("p",null,Object(a.b)("img",{alt:"Database schema design for Klappir's access controls",src:"https://static.klappir.io/img/docs/access_controls_tables.png"}),' "Database schema design for Klappir\'s access controls"\n(Chart generated via ',Object(a.b)("a",s({parentName:"p"},{href:"https://www.dbdesigner.net"}),"DbDesigner.net"),")"),Object(a.b)("h2",{id:"react-implementation"},"React Implementation"),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},Object(a.b)("em",{parentName:"strong"},"Note that checking for permissions in the client is not enough to\nsecurely limit access to features.")),"\nAccess permissions should always be checked on the server/GraphQL."),Object(a.b)("p",null,"Most of the time there is no need to use the flags directly from the\nRedux state. In fact doing so is discouraged since this implementation\nmight change at some point, eg. if we might want to remove Redux.\nWe have a set of components that make this whole thing easer to work with\nand abstract some implementation details away."),Object(a.b)("h3",{id:"components"},"Components"),Object(a.b)("p",null,"All components share the same api for dealing with permissions"),Object(a.b)("table",null,Object(a.b)("thead",{parentName:"table"},Object(a.b)("tr",{parentName:"thead"},Object(a.b)("th",s({parentName:"tr"},{align:null}),"Param"),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Type"),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Default","Â ","value"),Object(a.b)("th",s({parentName:"tr"},{align:null}),"Description"))),Object(a.b)("tbody",{parentName:"table"},Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),"has"),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"string")," or ",Object(a.b)("inlineCode",{parentName:"td"},"Array<string>")),Object(a.b)("td",s({parentName:"tr"},{align:null})),Object(a.b)("td",s({parentName:"tr"},{align:null}),"List of feature flags needed to access feature")),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),"all"),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"boolean")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"false")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"Whether all listed flags are needed to gain access.")),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),"fallback"),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"React.Node")),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"null")),Object(a.b)("td",s({parentName:"tr"},{align:null}),"Optional fallback to be rendered when permission is not granted.")),Object(a.b)("tr",{parentName:"tbody"},Object(a.b)("td",s({parentName:"tr"},{align:null}),"resolver"),Object(a.b)("td",s({parentName:"tr"},{align:null}),Object(a.b)("inlineCode",{parentName:"td"},"Resolver")),Object(a.b)("td",s({parentName:"tr"},{align:null})),Object(a.b)("td",s({parentName:"tr"},{align:null}),"Optional custom function to resolve access")))),Object(a.b)("pre",null,Object(a.b)("code",s({parentName:"pre"},{className:"language-javascript"}),"type Resolver =\n  (permissionsList: Array<string>, userPermissions: Array<string>) => boolean\n")),Object(a.b)("h4",{id:"permissions"},"Permissions"),Object(a.b)("p",null,"A simple gate component that wraps features that need special permissions to use."),Object(a.b)("pre",null,Object(a.b)("code",s({parentName:"pre"},{className:"language-import",metastring:"Permissions from './Permissions/Permissions.js';",Permissions:!0,from:!0,"'./Permissions/Permissions.js';":!0}),"import { PERMISSION_KEY } from './permissions.js';\n\nconst PermissionButton = () => (\n  <Permissions\n    has={PERMISSION_KEY}\n    fallback={<p>You don't have access to this feature</p>}\n  >\n    <button onClick={doSomething()}>Delete Everything</button>\n  </Permission>\n);\n")),Object(a.b)("h4",{id:"permissionsroute"},"PermissionsRoute"),Object(a.b)("p",null,Object(a.b)("a",s({parentName:"p"},{href:"https://reacttraining.com/react-router/web/api/Route",title:"Route API Documentation"}),"React-Router's ",Object(a.b)("inlineCode",{parentName:"a"},"Route"))," wrapped with permissions, and logic to enable ",Object(a.b)("a",s({parentName:"p"},{href:"https://reactjs.org/blog/2018/10/23/react-v-16-6.html#reactlazy-code-splitting-with-suspense"}),"React\n16.6's Suspense")," feature to do route-based ",Object(a.b)("a",s({parentName:"p"},{href:"https://reactjs.org/docs/code-splitting.html"}),"code-splitting"),"."),Object(a.b)("p",null,"In addition to the React-Router Route API and the above Permissions API,\nit adds the following in order to load components lazily:\n| Param         | Type            | Description\n|---------------|-----------------|---\n| lazyComponent | ",Object(a.b)("inlineCode",{parentName:"p"},"() => Promise")," | Component that should be loaded lazily\n| lazyFallback  | ",Object(a.b)("inlineCode",{parentName:"p"},"React.Node"),"    | Component to be rendered when loading"),Object(a.b)("p",null,"Example:"),Object(a.b)("pre",null,Object(a.b)("code",s({parentName:"pre"},{className:"language-javascript"}),"import Route from './Permissions/PermissionsRoute';\nimport SomeComponent from './SomeComponent';\n\nimport { SOME_ROUTE, SOME_OTHER_ROUTE } from './routes';\nimport { FEATURE_FLAG, ANOTHER_FEATURE_FLAG } from './permissions';\n\nconst LazyComponent = () => import('./MyComponent');\n\nconst SomeRoutes = () => {\n  return (\n    <>\n      <Route\n        has={[FEATURE_FLAG, ANOTHER_FEATURE_FLAG]}\n        all\n        fallback={<p>You don't have access to the feature</p>}\n        lazyComponent={LazyComponent}\n        lazyFallback={<div>Loading...</div>}\n      />\n      <Route\n        has={FEATURE_FLAG}\n        component={SomeComponent}\n        fallback={<p>You don't have access to the feature</p>}\n      />\n    </>\n  );\n}\n")),Object(a.b)("h4",{id:"other-simple-components"},"Other simple components"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("strong",{parentName:"li"},"PermissionsLink"),": ",Object(a.b)("inlineCode",{parentName:"li"},"ParamsLink")," wrapped with Permissions"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("strong",{parentName:"li"},"PermissionsNavLink"),": ",Object(a.b)("inlineCode",{parentName:"li"},"ParamsNavLink")," wrapped with Permissions")),Object(a.b)("h4",{id:"withpermissions"},"withPermissions"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"withPermissions")," is a ",Object(a.b)("a",s({parentName:"p"},{href:"https://reactjs.org/docs/higher-order-components.html"}),"higher-order component"),"\nthat is the foundation to many of the above components, but can\nalso be used to wrap new ones."),Object(a.b)("h3",{id:"best-practices"},"Best practices"),Object(a.b)("h3",{id:"redux"},"Redux"),Object(a.b)("p",null,"A logged in user's ",Object(a.b)("inlineCode",{parentName:"p"},"permission_keys")," and ",Object(a.b)("inlineCode",{parentName:"p"},"roles")," are stored in the ",Object(a.b)("inlineCode",{parentName:"p"},"profile")," section in the state:"),Object(a.b)("pre",null,Object(a.b)("code",s({parentName:"pre"},{className:"language-javascript"}),"state: {\n  ...\n  profile: {\n    permissions: ['key1', 'key2'],\n    roles: ['role1', 'role2'],\n    ...\n  }\n}\n")),Object(a.b)("h2",{id:"new-features-and-products"},"New features and products"),Object(a.b)("h3",{id:"adding-a-feature-flag"},"Adding a Feature Flag"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Add your new key to ",Object(a.b)("inlineCode",{parentName:"p"},"permission_keys")," table with a description."),Object(a.b)("ul",{parentName:"li"},Object(a.b)("li",{parentName:"ul"},"Key names should be predictable and structured."),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"[product category]_[product]_[feature]")," eg.: ",Object(a.b)("inlineCode",{parentName:"li"},"core_users_add")," or ",Object(a.b)("inlineCode",{parentName:"li"},"advance_maritime_voyages_full")))),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Add the new key to appropriate roles and products in ",Object(a.b)("inlineCode",{parentName:"p"},"role_permissions")," and ",Object(a.b)("inlineCode",{parentName:"p"},"product_permissions")," respectively.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Add new key to appropriate ",Object(a.b)("inlineCode",{parentName:"p"},"permissions.js")," file. Each product category has its own\nfolder and its own ",Object(a.b)("inlineCode",{parentName:"p"},"permissions.js")," file where its permission keys are kept and exported as variables."),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",s({parentName:"pre"},{}),"```javascript\n// src/core/permissions.js\nexport const CORE_USERS_ADD = 'core_users_add';\n```\n* _Feature flags should always be used as imported variables, **never as direct strings**._ This makes it easier to\n  update flag strings, makes errors and typos obvious, and enables intellisense autocomplete.\n")))),Object(a.b)("h3",{id:"adding-a-product"},"Adding a Product"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Add your new product to ",Object(a.b)("inlineCode",{parentName:"li"},"products")," table with a description and whatever other information you have on it.",Object(a.b)("ul",{parentName:"li"},Object(a.b)("li",{parentName:"ul"},"Key names should be predictable and structured."),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"[product category]_[product]_[sub-product]")," eg.: ",Object(a.b)("inlineCode",{parentName:"li"},"core_users")," or ",Object(a.b)("inlineCode",{parentName:"li"},"advance_maritime_voyages")))),Object(a.b)("li",{parentName:"ol"},"Add feature flags to the new product via ",Object(a.b)("inlineCode",{parentName:"li"},"product_permission"))),Object(a.b)("h3",{id:"adding-a-role"},"Adding a Role"),Object(a.b)("h2",{id:"future-development"},"Future Development"),Object(a.b)("p",null,"Currently (as of 2019-01-15) users can only be associated with a company,\nand thus access to features and, more importantly, data, can only be limited\nto the company level. We plan on changing the structure for companies and assets to\nallow different connections to users."),Object(a.b)("p",null,"Currently (as of 2019-01-15) a legacy table called ",Object(a.b)("inlineCode",{parentName:"p"},"user_permissions")," does\nexist, but is not used. We are discussing whether to add it to this system\nis a similar fashion to ",Object(a.b)("inlineCode",{parentName:"p"},"company_permissions"),"."))}b&&b===Object(b)&&Object.isExtensible(b)&&!b.hasOwnProperty("__filemeta")&&Object.defineProperty(b,"__filemeta",{configurable:!0,value:{name:"MDXContent",filename:"Documents/access_controls.mdx"}}),b.isMDXComponent=!0}}]);
//# sourceMappingURL=component---documents-access-controls-mdx-9a3298077c8eade35e18.js.map